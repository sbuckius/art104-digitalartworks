<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Digital Artwork</title>

  <style>
  :root { --gap: 14px; --tile: 130px; }

  body { 
    font-family: system-ui, Arial, sans-serif; 
    margin: 0; 
    padding: 18px; 
    background: #fafafa; 
  }

  /* ⬅️ WIDER PAGE */
  #captureArea { 
    max-width: 1800px; 
    margin: 0 auto; 
  }

  h1 { 
    font-size: 20px; 
    margin: 0 0 12px; 
    font-weight: 650; 
  }

  .bar {
    display: flex; 
    flex-wrap: wrap; 
    gap: 10px; 
    align-items: center;
    background: white; 
    padding: 12px; 
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
    margin-bottom: 14px;
  }

  .bar button {
    border: 0; 
    padding: 10px 12px; 
    border-radius: 10px; 
    cursor: pointer;
    background: #111; 
    color: #fff; 
    font-weight: 650;
  }

  .bar button.secondary { 
    background: #fff; 
    color: #111; 
    border: 1px solid #ddd; 
  }

  .status { 
    font-size: 14px; 
    color: #444; 
  }

  /* ✅ VERY BIG TILES */
  .grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));   /* BIG tiles */
    gap: var(--gap);
  }

  /* Mobile */
  @media (max-width: 900px) {
    .grid { 
      grid-template-columns: repeat(2, minmax(0, 1fr)); 
    }
  }

  .cell {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
    display: flex;
    flex-direction: column;
    cursor: pointer;
    user-select: none;
  }

  .imgWrap {
    position: relative;
    aspect-ratio: 1 / 1;
    background: #f1f1f1;
    overflow: hidden;
  }

  .imgWrap img {
    width: 100%; 
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .placeholder {
    width: 100%; 
    height: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    color: #777; 
    font-size: 14px; 
    padding: 12px; 
    text-align: center;
  }

  .meta {
    position: absolute; 
    left: 10px; 
    top: 10px;
    background: rgba(0,0,0,.55); 
    color: #fff; 
    font-size: 12px;
    padding: 6px 8px; 
    border-radius: 999px; 
    backdrop-filter: blur(6px);
  }

  /* ⬅️ BIGGER CAPTION TEXT */
  .caption {
    padding: 12px 12px 8px;
    border-top: 1px solid #eee;
    min-height: 44px;
    font-size: 14px;
    display: flex; 
    align-items: center;
    word-break: break-word;
  }

  .links {
    padding: 0 12px 14px;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .links a {
    color: #2563eb;
    text-decoration: underline;
    word-break: break-all;
  }

/* ================= MODAL ================= */

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 100;
}

.modal.open { 
  display: flex; 
}

.panel {
  width: min(560px, 96vw);
  background: white;
  border-radius: 18px;
  padding: 16px;
  box-shadow: 0 18px 70px rgba(0,0,0,.35);
}

.panel h2 { 
  margin: 0 0 12px; 
  font-size: 18px; 
}

.row { 
  display: flex; 
  flex-direction: column;
  gap: 10px; 
}

.panel input[type="file"] { 
  width: 100%; 
}

.panel input[type="text"] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #ddd;
  outline: none;
  font-size: 14px;
}

.panel .buttons { 
  display: flex; 
  justify-content: flex-end; 
  gap: 10px; 
  margin-top: 12px; 
}

.panel button {
  border: 0; 
  padding: 10px 12px; 
  border-radius: 10px; 
  cursor: pointer;
  background: #111; 
  color: #fff; 
  font-weight: 650;
}

.panel button.secondary { 
  background: #fff; 
  color: #111; 
  border: 1px solid #ddd; 
}

/* ================= LIGHTBOX ================= */

.lightbox {
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,.75);
  display: none; 
  align-items: center; 
  justify-content: center; 
  padding: 18px;
  z-index: 200;
}

.lightbox.open { 
  display: flex; 
}

.lightbox img {
  max-width: min(1100px, 96vw);
  max-height: 92vh;
  border-radius: 16px;
  background: #000;
}
</style>
</head>

<body>
  <div id="captureArea">
    <h1>
      Please upload an image of your favorite digital artwork, add a caption,
      and optionally include one or two website links related to your work.
    </h1>

    <div class="bar">
      <button id="resetBtn" class="secondary">Reset Images</button>
      <button id="saveBtn" class="secondary">Save Screen</button>
      <span class="status" id="status">
        Click a square to add or replace an image, caption, and links.
      </span>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <!-- Upload Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <h2 id="modalTitle">Add to tile</h2>
      <div class="row">
        <input id="fileInput" type="file" accept="image/*" />
        <input id="captionInput" type="text" maxlength="500" placeholder="Type a caption (optional)..." />
        <input id="link1Input" type="text" placeholder="Website link 1 (optional)..." />
        <input id="link2Input" type="text" placeholder="Website link 2 (optional)..." />
      </div>
      <div class="buttons">
        <button id="cancelBtn" class="secondary">Cancel</button>
        <button id="uploadBtn" disabled>Upload to Tile</button>
      </div>
      <div class="status" id="modalStatus" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <img id="lightboxImg" alt="Full view" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase, ref as dbRef, onValue, set, remove, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyBCLpqzaQED9PpwSzVOgmEmx9PMngVqaoE",
      authDomain: "art104digitalartwork.firebaseapp.com",
      databaseURL: "https://art104digitalartwork-default-rtdb.firebaseio.com",
      projectId: "art104digitalartwork",
      storageBucket: "art104digitalartwork.firebasestorage.app",
      messagingSenderId: "658605624357",
      appId: "1:658605624357:web:9ba9695568e8e2afdf83cc",
      measurementId: "G-1BP2M55DJR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ROWS = 5;
    const COLS = 10;
    const TILE_COUNT = ROWS * COLS;
    const MAX_EDGE = 320;
    const JPEG_QUALITY = 0.75;

    const clientId = (() => {
      const k = "quiltClientId";
      let v = localStorage.getItem(k);
      if (!v) {
        v = (crypto.randomUUID?.() || String(Math.random()).slice(2)).slice(0, 8);
        localStorage.setItem(k, v);
      }
      return v;
    })();

    const gridEl = document.getElementById("grid");
    const statusEl = document.getElementById("status");
    const resetBtn = document.getElementById("resetBtn");
    const saveBtn = document.getElementById("saveBtn");
    const captureArea = document.getElementById("captureArea");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const fileInput = document.getElementById("fileInput");
    const captionInput = document.getElementById("captionInput");
    const link1Input = document.getElementById("link1Input");
    const link2Input = document.getElementById("link2Input");
    const uploadBtn = document.getElementById("uploadBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const modalStatus = document.getElementById("modalStatus");

    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightboxImg");

    let activeIndex = null;
    let activeFile = null;

    function setStatus(msg) { statusEl.textContent = msg; }
    function setModalStatus(msg) { modalStatus.textContent = msg; }

    function openModal(index) {
      activeIndex = index;
      activeFile = null;
      fileInput.value = "";
      captionInput.value = "";
      link1Input.value = "";
      link2Input.value = "";
      uploadBtn.disabled = true;
      modalTitle.textContent = `Tile ${index + 1} of ${TILE_COUNT}`;
      setModalStatus(`Choose an image for tile ${index + 1}.`);
      modal.classList.add("open");
    }

    function closeModal() {
      modal.classList.remove("open");
      activeIndex = null;
      activeFile = null;
    }

    const cellEls = [];

    for (let i = 0; i < TILE_COUNT; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";

      const wrap = document.createElement("div");
      wrap.className = "imgWrap";

      const placeholder = document.createElement("div");
      placeholder.className = "placeholder";
      placeholder.textContent = "Click to add artwork";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `#${i+1}`;

      wrap.appendChild(placeholder);
      wrap.appendChild(meta);

      const cap = document.createElement("div");
      cap.className = "caption";

      const links = document.createElement("div");
      links.className = "links";

      cell.appendChild(wrap);
      cell.appendChild(cap);
      cell.appendChild(links);
      gridEl.appendChild(cell);

      cell.addEventListener("click", () => openModal(i));
      cellEls.push({ wrap, cap, links, meta, placeholder });
    }

    const quiltRef = dbRef(db, "quiltTiles");
    onValue(quiltRef, (snap) => renderQuilt(snap.val() || {}));

    function renderQuilt(tiles) {
      for (let i = 0; i < TILE_COUNT; i++) {
        const t = tiles[i];
        const { wrap, cap, links, meta, placeholder } = cellEls[i];

        wrap.innerHTML = "";
        wrap.appendChild(meta);
        links.innerHTML = "";

        if (t?.dataUrl) {
          const img = document.createElement("img");
          img.src = t.dataUrl;
          wrap.appendChild(img);
          img.addEventListener("click", (e) => {
            e.stopPropagation();
            openLightbox(t.dataUrl);
          });

          cap.textContent = t.caption || "(no caption)";

          if (t.link1) {
            const a = document.createElement("a");
            a.href = t.link1.startsWith("http") ? t.link1 : `https://${t.link1}`;
            a.textContent = t.link1;
            a.target = "_blank";
            links.appendChild(a);
          }

          if (t.link2) {
            const a = document.createElement("a");
            a.href = t.link2.startsWith("http") ? t.link2 : `https://${t.link2}`;
            a.textContent = t.link2;
            a.target = "_blank";
            links.appendChild(a);
          }

        } else {
          wrap.appendChild(placeholder);
          cap.textContent = "";
        }
      }
    }

    fileInput.addEventListener("change", () => {
      activeFile = fileInput.files?.[0] || null;
      uploadBtn.disabled = !activeFile;
    });

    cancelBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    async function fileToCompressedDataUrl(file) {
      const dataUrl = await new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(file);
      });

      const img = await new Promise(res => {
        const im = new Image();
        im.onload = () => res(im);
        im.src = dataUrl;
      });

      const scale = Math.min(1, 320 / Math.max(img.width, img.height));
      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL("image/jpeg", 0.75);
    }

    uploadBtn.addEventListener("click", async () => {
      if (!activeFile || activeIndex === null) return;

      const dataUrl = await fileToCompressedDataUrl(activeFile);

      await set(dbRef(db, `quiltTiles/${activeIndex}`), {
        dataUrl,
        caption: captionInput.value.trim(),
        link1: link1Input.value.trim(),
        link2: link2Input.value.trim(),
        clientId,
        updatedAt: serverTimestamp()
      });

      closeModal();
    });

    resetBtn.addEventListener("click", async () => {
      if (!confirm("Reset clears ALL quilt tiles for everyone. Continue?")) return;
      await remove(dbRef(db, "quiltTiles"));
    });

    saveBtn.addEventListener("click", async () => {
      const canvas = await window.html2canvas(captureArea, { scale: 2 });
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = `quilt_${Date.now()}.png`;
      a.click();
    });

    function openLightbox(url) {
      lightboxImg.src = url;
      lightbox.classList.add("open");
    }
    lightbox.addEventListener("click", () => {
      lightbox.classList.remove("open");
      lightboxImg.src = "";
    });

  </script>
</body>
</html>
